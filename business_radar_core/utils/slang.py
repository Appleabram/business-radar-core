"""
Kazakhstan slang and regional speech normalization
Словарь для нормализации смешанной речи (казахский + русский + сленг)

Архитектура позволяет дополнять словарь без изменения логики бота.
"""
import re
from typing import Dict, List, Tuple


class SlangNormalizer:
    """
    Нормализация казахстанского сленга и региональной речи
    """
    
    def __init__(self):
        # Словарь нормализации: сленг/разговорное → бизнес-смысл
        self.slang_dict: Dict[str, str] = {
            # Деньги и суммы
            "теңге": "тенге",
            "тенге": "тенге",
            "тг": "тенге",
            "тыс": "тысяч",
            "тыща": "тысяч",
            "лям": "миллион",
            "лямов": "миллионов",
            "миллиард": "миллиард",
            "млрд": "миллиард",
            "млн": "миллион",
            
            # Долги и оплаты
            "қарыз": "долг",
            "долг": "долг",
            "берешек": "долг",
            "төлем": "оплата",
            "оплата": "оплата",
            "ақша": "деньги",
            "деньги": "деньги",
            "төлеу": "платить",
            "платить": "платить",
            "қайтару": "вернуть",
            "вернуть": "вернуть",
            
            # Время
            "ай": "месяц",
            "ай бұрын": "месяцев назад",
            "жыл": "год",
            "жыл бұрын": "год назад",
            "күн": "день",
            "күн бұрын": "дней назад",
            "апта": "неделя",
            "былтыр": "в прошлом году",
            "биыл": "в этом году",
            
            # Люди и роли
            "адам": "человек",
            "кісі": "человек",
            "сотрудник": "сотрудник",
            "қызметкер": "сотрудник",
            "клиент": "клиент",
            "тұтынушы": "клиент",
            "сатып алушы": "покупатель",
            "покупатель": "покупатель",
            "серіктес": "партнёр",
            "партнёр": "партнёр",
            "дос": "друг",
            "таныс": "знакомый",
            "туыс": "родственник",
            "ағайын": "родственники",
            "қарыздар": "должник",
            "должник": "должник",
            
            # Бизнес и операции
            "бизнес": "бизнес",
            "іс": "дело",
            "сауда": "торговля",
            "сату": "продажа",
            "сатып алу": "покупка",
            "тауар": "товар",
            "өнім": "продукция",
            "қызмет": "услуга",
            "услуга": "услуга",
            "нарық": "рынок",
            "рынок": "рынок",
            "баға": "цена",
            "цена": "цена",
            "арзан": "дешёвый",
            "қымбат": "дорогой",
            "пайда": "прибыль",
            "прибыль": "прибыль",
            "зиян": "убыток",
            "убыток": "убыток",
            "шығын": "расходы",
            "расходы": "расходы",
            
            # Оценка и риски
            "жақсы": "хороший",
            "жаман": "плохой",
            "қауіп": "риск",
            "риск": "риск",
            "тәуекел": "риск",
            "сенімді": "надёжный",
            "сенімсіз": "ненадёжный",
            "алдаяды": "обманывает",
            "алдау": "обман",
            "обман": "обман",
            
            # Города Казахстана
            "алматы": "Алматы",
            "астана": "Астана",
            "нұр-сұлтан": "Астана",
            "шымкент": "Шымкент",
            "қарағанды": "Караганда",
            "актөбе": "Актобе",
            "тараз": "Тараз",
            "павлодар": "Павлодар",
            "өскемен": "Усть-Каменогорск",
            "семей": "Семей",
            "орал": "Уральск",
            "қызылорда": "Кызылорда",
            "петропавл": "Петропавловск",
            "көкшетау": "Кокшетау",
            "ташкент": "Ташкент",
            "москва": "Москва",
            "китай": "Китай",
            "қытай": "Китай",
            
            # Разговорные и сленговые выражения
            "короче": "",
            "в общем": "",
            "типа": "",
            "как бы": "",
            "ну": "",
            "әйтеуір": "",
            "қалай десем": "",
            "білесіз бе": "",
            "түсінесіз бе": "",
            "понимаете": "",
            "қазір": "сейчас",
            "енді": "теперь",
            "міне": "вот",
            "анау": "тот",
            "мынау": "этот",
            "осы": "этот",
            "сол": "тот",
            
            # Смешанные формы (каз+рус)
            "бизнесім": "мой бизнес",
            "бизнесің": "твой бизнес",
            "бизнесі": "его бизнес",
            "жұмысым": "моя работа",
            "жұмысың": "твоя работа",
            "ақшам": "мои деньги",
            "ақшаң": "твои деньги",
            "тауарым": "мой товар",
            "клиентім": "мой клиент",
            "қарызым": "мой долг",
            
            # Глаголы в разговорной форме
            "істеп жатырмын": "работаю",
            "істеп жүрмін": "работаю",
            "жасап жатырмын": "делаю",
            "қарап жатырмын": "смотрю",
            "ойлап жатырмын": "думаю",
            "айтып жатырмын": "говорю",
            
            # Числительные на казахском
            "бір": "1",
            "екі": "2",
            "үш": "3",
            "төрт": "4",
            "бес": "5",
            "алты": "6",
            "жеті": "7",
            "сегіз": "8",
            "тоғыз": "9",
            "он": "10",
            "жиырма": "20",
            "отыз": "30",
            "қырық": "40",
            "елу": "50",
            "алпыс": "60",
            "жетпіс": "70",
            "сексен": "80",
            "тоқсан": "90",
            "жүз": "100",
        }
        
        # Паттерны для извлечения сущностей
        self.entity_patterns = {
            "amount": r"\b(\d+(?:[\s,]?\d{3})*(?:\.\d+)?)\s*(тенге|теңге|тг|тыс|тыща|лям|миллион|млн|миллиард|млрд)?\b",
            "date": r"\b(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})\b",
            "date_relative": r"\b(\d+\s*(ай|күн|жыл|апта)\s*(бұрын|артық))\b",
            "phone": r"\b(\+7\s*\d{3}\s*\d{3}[-\s]?\d{2}[-\s]?\d{2})\b",
            "city": r"\b(алматы|астана|нұр-сұлтан|шымкент|қарағанды|актөбе|тараз|павлодар|өскемен|семей|орал|қызылорда|петропавл|көкшетау|москва|ташкент|китай|қытай)\b",
        }
        
        # Слова-паразиты (удаляем)
        self.filler_words = {
            "әйтеуір", "қалай десем", "білесіз бе", "түсінесіз бе",
            "короче", "в общем", "типа", "как бы", "ну", "понимаете",
            "это самое", "значит", "так сказать", "вроде как",
        }
    
    def normalize(self, text: str) -> str:
        """
        Нормализовать текст: заменить сленг на стандартные формы
        """
        if not text:
            return ""
        
        # Привести к нижнему регистру для поиска, но сохранить оригинал
        text_lower = text.lower()
        result = text_lower
        
        # Удалить слова-паразиты
        for filler in self.filler_words:
            result = re.sub(
                r'\b' + re.escape(filler) + r'\b',
                '',
                result,
                flags=re.IGNORECASE
            )
        
        # Заменить сленг на стандартные формы
        # Сортируем по длине (сначала длинные), чтобы заменить более специфичные
        for slang, standard in sorted(
            self.slang_dict.items(),
            key=lambda x: len(x[0]),
            reverse=True
        ):
            result = re.sub(
                r'\b' + re.escape(slang) + r'\b',
                standard,
                result,
                flags=re.IGNORECASE
            )
        
        # Удалить лишние пробелы
        result = re.sub(r'\s+', ' ', result).strip()
        
        return result
    
    def extract_entities(self, text: str) -> Dict[str, List[Tuple[str, str]]]:
        """
        Извлечь ключевые сущности: суммы, сроки, города, роли
        
        Возвращает dict: {entity_type: [(original_text, normalized_value), ...]}
        """
        entities = {}
        
        # Суммы
        amounts = []
        for match in re.finditer(self.entity_patterns["amount"], text, re.IGNORECASE):
            original = match.group(0)
            value = match.group(1).replace(',', '').replace(' ', '')
            unit = match.group(2) or ""
            
            # Нормализовать единицы
            unit_map = {
                "тенге": 1, "теңге": 1, "тг": 1,
                "тыс": 1000, "тыща": 1000,
                "лям": 1000000, "миллион": 1000000, "млн": 1000000,
                "миллиард": 1000000000, "млрд": 1000000000,
            }
            multiplier = unit_map.get(unit.lower() if unit else "", 1)
            normalized_value = float(value) * multiplier
            
            amounts.append((original, str(normalized_value)))
        if amounts:
            entities["amounts"] = amounts
        
        # Даты
        dates = []
        for match in re.finditer(self.entity_patterns["date"], text):
            dates.append((match.group(0), match.group(0)))
        if dates:
            entities["dates"] = dates
        
        # Относительные даты
        relative_dates = []
        for match in re.finditer(self.entity_patterns["date_relative"], text, re.IGNORECASE):
            original = match.group(0)
            number = int(match.group(1).split()[0])
            unit = match.group(2).lower()
            ago = match.group(3).lower() if match.group(3) else ""
            
            # Нормализовать единицы времени
            unit_map = {
                "күн": "дней", "ай": "месяцев",
                "жыл": "лет", "апта": "недель",
            }
            normalized = f"{number} {unit_map.get(unit, unit)} {ago}"
            relative_dates.append((original, normalized))
        if relative_dates:
            entities["relative_dates"] = relative_dates
        
        # Города
        cities = []
        for match in re.finditer(self.entity_patterns["city"], text, re.IGNORECASE):
            original = match.group(0)
            normalized = self.slang_dict.get(original.lower(), original)
            cities.append((original, normalized))
        if cities:
            entities["cities"] = cities
        
        # Телефоны
        phones = []
        for match in re.finditer(self.entity_patterns["phone"], text):
            phones.append((match.group(0), match.group(0)))
        if phones:
            entities["phones"] = phones
        
        return entities
    
    def process_voice_transcription(self, text: str) -> Tuple[str, Dict]:
        """
        Обработать транскрипцию голосового сообщения
        
        Возвращает: (нормализованный текст, извлечённые сущности)
        """
        normalized = self.normalize(text)
        entities = self.extract_entities(text)
        
        return normalized, entities
    
    def add_custom_slang(self, slang: str, meaning: str) -> None:
        """
        Добавить новое сленговое слово в словарь
        
        :param slang: сленговое выражение
        :param meaning: бизнес-смысл
        """
        self.slang_dict[slang.lower()] = meaning
    
    def load_from_file(self, filepath: str) -> None:
        """
        Загрузить дополнительные сленговые выражения из файла
        
        Формат файла: slang|meaning (по одному на строку)
        """
        try:
            with open(filepath, 'r', encoding='utf-8') as f:
                for line in f:
                    line = line.strip()
                    if line and '|' in line:
                        parts = line.split('|', 1)
                        if len(parts) == 2:
                            slang, meaning = parts
                            self.add_custom_slang(slang.strip(), meaning.strip())
        except FileNotFoundError:
            pass  # Файл не найден — это нормально


# Глобальный экземпляр
normalizer = SlangNormalizer()
