"""
Narrative system: explanations before each question
КРИТИЧНО: Объяснение и вопрос отправляются РАЗДЕЛЬНЫМИ сообщениями!
"""
from typing import Dict, Tuple, Optional

from src.database import ModuleType


# Универсальный базовый текст
BASE_NARRATIVE = {
    "kk": {
        "explanation": "Қазір маңызды сұрақ қоямын. Қысқа немесе үстірт жауап берсең, нәтиже дәл болмайды. Қалай бар — солай жаз. Бұл кейін ақша мен уақытыңды үнемдейді.",
        "warning": "Бұлай жауап берсең, мен қателесуім мүмкін. Аздап кеңірек жазайық."
    },
    "ru": {
        "explanation": "Сейчас важный вопрос. Короткий или поверхностный ответ даст неточный результат. Напиши так, как есть на самом деле — это сэкономит тебе деньги и время.",
        "warning": "С таким ответом я могу ошибиться. Давай чуть подробнее."
    }
}

# Специализированные обоснования по типам вопросов
SPECIAL_NARRATIVES = {
    "amount": {
        "kk": {
            "explanation": "Сома — жай цифр емес. Осыған қарап, қысым жасау керек пе, әлде тоқтаған дұрыс па — соны анықтаймыз. Дәл соманы жаз.",
        },
        "ru": {
            "explanation": "Сумма — не просто цифра. От неё зависит, имеет ли смысл давить дальше или лучше остановиться. Напиши точную сумму.",
        }
    },
    "date": {
        "kk": {
            "explanation": "7 күн мен 70 күн — екі түрлі жағдай. Нақты қанша күн өткенін жаз.",
        },
        "ru": {
            "explanation": "7 и 70 дней — это разные ситуации. Напиши, сколько дней прошло на самом деле.",
        }
    },
    "description": {
        "kk": {
            "explanation": "Атауы емес, мәні маңызды. Клиентке қалай түсіндірер едің — солай жаз.",
        },
        "ru": {
            "explanation": "Важно не название, а суть. Опиши так, как объяснил бы клиенту.",
        }
    },
    "goal": {
        "kk": {
            "explanation": "Мақсат түсініксіз болса, ақша көбіне «қатып» қалады. Не үшін керек екенін жаз.",
        },
        "ru": {
            "explanation": "Если цель неясна, деньги часто «зависают». Напиши, зачем это тебе.",
        }
    },
    "people": {
        "kk": {
            "explanation": "Бұл сұрақ галочка үшін емес. Ол адамның жұмыста қалай болатынын көрсетеді.",
        },
        "ru": {
            "explanation": "Этот вопрос показывает, как человек ведёт себя в реальной работе.",
        }
    },
    "first": {
        "kk": {
            "explanation": "Бұл тест емес. Қысқа жауаптар жалған үміт береді. Шынайы жаз.",
        },
        "ru": {
            "explanation": "Это не тест. Короткие ответы часто дают ложную картину.",
        }
    },
    "idea_description": {
        "kk": {
            "explanation": "Идеяңді толық сипаттамау — өзін алдау. Не сатасың нақты?",
        },
        "ru": {
            "explanation": "Без чёткого описания идеи нельзя найти слабые места. «Буду продавать одежду» — это не идея.",
        }
    },
    "target_audience": {
        "kk": {
            "explanation": "«Барлығына сатамын» десең — ешкімге сата алмайсың. Клиентің нақты кім?",
        },
        "ru": {
            "explanation": "Если не знаешь, кто твой клиент — не сможешь до него достучаться. «Все» — это не аудитория.",
        }
    },
    "investment": {
        "kk": {
            "explanation": "Соңғы ақшаңды салу — үлкен тәуекел. Қанша жоғалтуға дайынсың?",
        },
        "ru": {
            "explanation": "Нужно понять, сколько готов потерять. Если вкладываешь последнее — риск неприемлем.",
        }
    },
    "competition": {
        "kk": {
            "explanation": "«Бәсекелес жоқ» десең — немесе іздемедің, немесе нарық жоқ. Кім бұны істеп жүр?",
        },
        "ru": {
            "explanation": "Если говоришь «конкурентов нет» — либо не искал, либо рынка нет. Нужно понять, с кем борешься.",
        }
    },
    "revenue_model": {
        "kk": {
            "explanation": "Қалай ақша табасың түсініксіз болса — идея өлі. Нақты жаз.",
        },
        "ru": {
            "explanation": "Без понимания, как именно зарабатываешь, идея мертва. Нужна конкретика: маржа, частота, чек.",
        }
    },
    "market_product": {
        "kk": {
            "explanation": "«Строительные материалы» — тым жалпы. Нақты атауын жаз.",
        },
        "ru": {
            "explanation": "Без точного названия продукта нельзя сравнить цены. «Строительные материалы» — слишком широко.",
        }
    },
    "market_price": {
        "kk": {
            "explanation": "Бағаң — бастапқы нүкте. Осысыз нарықтамысың, жоқ па — айта алмаймын.",
        },
        "ru": {
            "explanation": "Твоя цена — точка отсчёта. Без неё не скажу, в рынке ты или нет.",
        }
    },
    "market_city": {
        "kk": {
            "explanation": "Алматы мен Шымкентте бағалар 20-30% айырмашылығы болуы мүмкін.",
        },
        "ru": {
            "explanation": "Цены в Алматы и, например, в Шымкенте могут отличаться на 20-30%. Нужно сравнивать с твоим городом.",
        }
    },
    "hiring_position": {
        "kk": {
            "explanation": "Әр лауазымның өз тәуекелі бар. Бухгалтер жүк тиеушіден қауіптірек.",
        },
        "ru": {
            "explanation": "Разные должности — разные риски. Бухгалтер с доступом к деньгам опаснее грузчика.",
        }
    },
    "hiring_experience": {
        "kk": {
            "explanation": "Тәжірибе — кепілдік емес, бірақ сүзгі. Резюмеде нөл = қате мен жұмыстан кету қаупі.",
        },
        "ru": {
            "explanation": "Опыт работы — не гарантия, но фильтр. Полный ноль в резюме = высокий риск ошибок и увольнений.",
        }
    },
    "hiring_salary": {
        "kk": {
            "explanation": "Кандидат нарықтан төмен сұраса — немесе адекватты емес, немесе бірдеңе жасырады.",
        },
        "ru": {
            "explanation": "Если кандидат просит сильно ниже рынка — либо неадекватен, либо скрывает что-то. Если выше — может быстро уйти.",
        }
    },
    "import_product": {
        "kk": {
            "explanation": "Әр тауардың өз тәуекелі: кеден, сертификаттау, жеткізу мерзімі.",
        },
        "ru": {
            "explanation": "Разные товары — разные риски: таможня, сертификация, сроки доставки. Без точного названия нельзя оценить.",
        }
    },
    "import_country": {
        "kk": {
            "explanation": "Қытай, Түркия, Ресей — әртүрлі ережелер, мерзімдер және тәуекелдер.",
        },
        "ru": {
            "explanation": "Китай, Турция, Россия — разные правила, сроки и риски. От страны зависит всё: пошлины, логистика, возврат.",
        }
    },
    "import_batch": {
        "kk": {
            "explanation": "Бірінші партия тест үшін минималды болуы керек. Контейнерге тапсырыс берсең — бәрін жоғалту қаупі.",
        },
        "ru": {
            "explanation": "Первая партия должна быть минимальной для теста. Если сразу заказываешь контейнер — риск потерять всё.",
        }
    },
    "import_supplier": {
        "kk": {
            "explanation": "Импорт мәселелерінің 90% — сенімсіз жеткізуші. Оны тексердің бе?",
        },
        "ru": {
            "explanation": "90% проблем с импортом — ненадёжный поставщик. Нужно понять, проверял ли ты его вообще.",
        }
    },
    "import_payment": {
        "kk": {
            "explanation": "100% алдын ала төлем — максималды тәуекел. Жеткізуші мерзім бермесе — бұл сигнал.",
        },
        "ru": {
            "explanation": "100% предоплата — максимальный риск. Если поставщик не даёт отсрочку — это сигнал.",
        }
    }
}

# Вопросы для модуля долгов (Debt)
DEBT_QUESTIONS = {
    "kk": {
        "amount": "Қарыз соммасы қанша? (санмен жазыңыз, мысалы: 500000)",
        "date": "Қарыз қашан пайда болды? (күн/ай/жыл немесе «3 ай бұрын» деп жазыңыз)",
        "debtor_type": """Кім қарыз?

A) Жеке тұлға (таныс, дос, туыс)
B) Серіктес (ЖШС, ИП бар)
C) Клиент (төлем кешіктіру)
D) Белгісіз (қашып кеткен)

(Әріпті жазыңыз: A, B, C немесе D)""",
        "evidence": "Есть ли письменные доказательства долга? (расписка, договор, сообщения в WhatsApp)",
        "contact_status": "Должник выходит на связь? (да/нет/иногда)"
    },
    "ru": {
        "amount": "Какая сумма долга? (пишите цифрой, например: 500000)",
        "date": "Когда возник долг? (день/месяц/год или «3 месяца назад»)",
        "debtor_type": """Кто должен?

A) Частное лицо (знакомый, друг, родственник)
B) Партнёр (есть ТОО, ИП)
C) Клиент (просрочил оплату)
D) Неизвестно (исчез)

(Напишите букву: A, B, C или D)""",
        "evidence": "Есть ли письменные доказательства долга? (расписка, договор, переписка, сообщения)",
        "contact_status": "Должник выходит на связь? (да/нет/иногда)"
    }
}


def get_narrative_explanation(
    module: Optional[ModuleType],
    step: str,
    language: str = "ru",
    is_first_question: bool = False
) -> str:
    """
    Получить текст обоснования для вопроса
    
    :param module: тип модуля (для будущих спец-обоснований)
    :param step: тип вопроса (amount, date, description, etc.)
    :param language: 'kk' или 'ru'
    :param is_first_question: первый ли это вопрос сценария
    :return: текст обоснования
    """
    # Первый вопрос сценария имеет приоритет
    if is_first_question:
        return SPECIAL_NARRATIVES["first"][language]["explanation"]
    
    # Проверяем специализированное обоснование по типу вопроса
    if step in SPECIAL_NARRATIVES:
        return SPECIAL_NARRATIVES[step][language]["explanation"]
    
    # Базовое обоснование
    return BASE_NARRATIVE[language]["explanation"]


def get_question(
    module: ModuleType,
    step: str,
    language: str = "ru"
) -> str:
    """
    Получить текст вопроса
    
    :param module: тип модуля
    :param step: шаг вопроса
    :param language: 'kk' или 'ru'
    :return: текст вопроса
    """
    if module == ModuleType.DEBT:
        return DEBT_QUESTIONS.get(language, DEBT_QUESTIONS["ru"]).get(
            step, 
            BASE_NARRATIVE[language]["explanation"]
        )
    
    # Для других модулей - заглушка
    return "?"


def get_short_answer_warning(language: str = "ru") -> str:
    """
    Получить предупреждение о слишком коротком ответе
    """
    return BASE_NARRATIVE[language]["warning"]


def get_voice_confirmation(text: str, language: str = "ru") -> str:
    """
    Получить текст подтверждения голосового сообщения
    """
    if language == "kk":
        return f"Мен былай түсіндім:\n\n«{text}»\n\nДұрыс па? Қате болса — түзетіңіз."
    else:
        return f"Я понял так:\n\n«{text}»\n\nПравильно? Если нет — поправьте."
